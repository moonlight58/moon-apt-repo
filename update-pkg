#!/bin/bash
set -e

# ğŸ§­ Aller Ã  la racine du dÃ©pÃ´t
cd "$(dirname "$0")"

# ğŸ§¹ Supprimer les anciens index
echo "[INFO] Suppression des anciens fichiers d'index..."
rm -f dists/stable/main/binary-amd64/Packages*
rm -f dists/stable/Release*
rm -f dists/stable/InRelease

# ğŸ—ï¸ RÃ©gÃ©nÃ©rer les fichiers Packages et Packages.gz
echo "[INFO] GÃ©nÃ©ration de Packages et Packages.gz..."
dpkg-scanpackages -m pool/main /dev/null > dists/stable/main/binary-amd64/Packages
gzip -9 -k dists/stable/main/binary-amd64/Packages

# ğŸ§¾ CrÃ©er le fichier Release
echo "[INFO] GÃ©nÃ©ration du fichier Release..."
apt-ftparchive release dists/stable > dists/stable/Release

# ğŸ” Signature GPG (si ta clÃ© est dÃ©jÃ  importÃ©e)
echo "[INFO] Signature du dÃ©pÃ´t..."
gpg --yes --clearsign -o dists/stable/InRelease dists/stable/Release
gpg --yes -abs -o dists/stable/Release.gpg dists/stable/Release

# ğŸª£ VÃ©rification rapide
echo "[INFO] VÃ©rification du rÃ©sultat :"
ls -lh dists/stable/main/binary-amd64/
ls -lh dists/stable/

# ğŸª¶ (Optionnel) Commit et push automatique sur GitHub Pages
echo "[INFO] Commit et push vers GitHub Pages..."
git add dists/
git commit -m "Update APT index $(date '+%Y-%m-%d %H:%M:%S')"
git push origin gh-pages

echo "[âœ…] DÃ©pÃ´t APT mis Ã  jour avec succÃ¨s !"
